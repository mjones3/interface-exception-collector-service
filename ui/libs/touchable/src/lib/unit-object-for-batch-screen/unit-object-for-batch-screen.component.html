<div id="unitObjectBatchWrapper" class="flex flex-col flex-1 w-full">
  <!-- Top Fields Section -->
  <div class="scan-top-section flex flex-col flex-wrap">
    <treo-card>
      <div class="flex flex-row w-full space-x-0 p-8 flex-row">
        <ng-template *ngIf="applyLogicalOrderAndValidations && header" [ngTemplateOutlet]="header"> </ng-template>
        <div class="flex flex-row items-baseline" [ngClass]="{ 'mr-8': !applyLogicalOrderAndValidations }">
          <label class="mr-4 font-bold">{{ 'unit-number.label' | translate }}</label>
          <div class="flex flex-col">
            <!-- Scan Unit Number -->
            <rsa-input-keyboard
              [inputWidth]="'lt-lg:w-80 gt-md:w-100'"
              [(inputFocus)]="unitFocus"
              tabindex="-1"
              rsaBarcode
              [formControl]="unitNumberControl"
              [iconName]="'opacity'"
              [customErrors]="{ invalidUnitNumber: 'unit-number.label' | validation: validationType.INVALID }"
              [inputId]="'batchUnitNumberInput'"
              (tabOrEnterPressed)="onTabOrEnterPressed()"
              (blur)="unitFocusChange.emit(false)"
            ></rsa-input-keyboard>
          </div>
        </div>

        <ng-container *ngIf="showCentrifugeCode; else headerTemplate">
          <div class="flex flex-row items-baseline">
            <!-- Centrifuge Bar Code Field -->
            <label class="mr-4 font-bold">{{ 'centrifuge-barcode.label' | translate }}</label>
            <div class="flex flex-col">
              <rsa-input-keyboard
                [inputWidth]="'lt-lg:w-80 gt-md:w-100'"
                [formControl]="centrifugeBarcodeControl"
                [(inputFocus)]="centrifugeFocus"
                (blur)="centrifugeFocusChange.emit(false)"
                tabindex="-1"
                rsaBarcode
                [iconName]="'archive'"
                [inputId]="'batchCentrifugeInput'"
                (tabOrEnterPressed)="centrifugeScanned()"
                (inputChange)="inputChangeCentrifugeBarcode($event)"
              ></rsa-input-keyboard>
            </div>
          </div>
        </ng-container>
        <ng-template #headerTemplate>
          <ng-template *ngIf="!applyLogicalOrderAndValidations" [ngTemplateOutlet]="header"> </ng-template>
        </ng-template>
      </div>
    </treo-card>
  </div>

  <!-- Added Units Section -->
  <div class="added-units-section flex flex-col flex-grow my-4">
    <treo-card class="flex flex-grow">
      <div class="flex flex-col w-full">
        <!-- Header -->
        <div class="flex items-center justify-between w-full px-8 py-4 border-b border-gray-200">
          <div class="mr-6 flex items-baseline">
            <h4 class="m-0">{{ headerTitle | translate }}</h4>
            <h6 class="ml-4 my-0">{{ addedUnits.length }} {{ 'of.label' | translate }} {{ maxAddedUnits }}</h6>
          </div>

          <div class="flex items-center">
            <button
              id="removeAllBtn"
              mat-raised-button
              class="action-button"
              (click)="removeAll()"
              [disabled]="addedUnits.length === 0"
            >
              <mat-icon [svgIcon]="'rsa:remove-all'"></mat-icon>
              <span class="ml-2">{{ 'remove-all.label' | translate }}</span>
            </button>
          </div>
        </div>

        <!-- Scanned Units Section -->
        <div class="flex flex-1 py-4 min-h-40">
          <div class="flex flex-1 relative">
            <div
              *ngIf="addedUnits.length > 0"
              class="scrollable-content"
              treoScrollbar
              [treoScrollbarOptions]="{ wheelPropagation: false, suppressScrollX: true }"
            >
              <div
                class="flex flex-auto flex-row flex-wrap px-4"
                [ngClass]="{ 'h-full items-center justify-center': useCustomUnitCard }"
              >
                <ng-container
                  *ngTemplateOutlet="
                    useCustomUnitCard ? customProdCard : defaultProdCard;
                    context: { units: addedUnits }
                  "
                ></ng-container>
              </div>
            </div>
          </div>
        </div>
      </div>
    </treo-card>
  </div>

  <!-- Bottom Fields Section -->
  <div class="scan-bottom-section flex flex-col" *ngIf="footer">
    <treo-card>
      <ng-container [ngTemplateOutlet]="footer"></ng-container>
    </treo-card>
  </div>
</div>

<ng-template #defaultProdCard let-units="units">
  <mat-card
    matRipple
    class="product-button p-1 flex m-2 items-center"
    *ngFor="let product of units; index as i"
    (click)="deleteProduct(i)"
    [ngClass]="{ 'red-card': product.invalidProduct }"
  >
    <mat-icon
      [svgIcon]="
        product.invalidProduct
          ? 'rsa:apply-quarantine'
          : product.icon
          ? 'rsa:' + product.icon
          : 'rsa:dialog-confirmation'
      "
      class="product-icon"
    ></mat-icon>
    <div class="pl-2">
      <div>
        <b>{{ product.unitNumber }}</b>
      </div>
      <div class="product-sub-title">
        {{ (product.shortDescriptionKey ? product.shortDescriptionKey : product.descriptionKey) | translate }}
      </div>
      <div class="product-sub-title" *ngIf="addBloodTypeToCard">
        {{ addBloodTypeToCard === 'ABO+RH' ? product?.abo + product?.rh : product?.abo }}
      </div>
      <div class="product-sub-title" *ngIf="addPrtKitDescriptionToCard">
        {{ product?.prtKitDescription | translate }}
      </div>
    </div>
  </mat-card>
</ng-template>

<ng-template #customProdCard let-units="units">
  <mat-card matRipple class="product-button p-1 flex m-2 items-center" *ngFor="let product of units; index as i">
    <div class="p-3">
      <div class="flex flex-col">
        <div class="flex flex-row">
          <span class="font-bold mb-1 gt-xs:text-left gt-xs:mr-4 gt-xs:mb-0 w-30"
            >{{ 'unit-number.label' | translate }} :
          </span>
          <span class="treo-mat-no-subscript flex-auto gt-xs:mr-4 gt-xs:text-left">{{ product?.unitNumber }}</span>
        </div>
      </div>
      <div class="flex flex-col">
        <div class="flex flex-row">
          <span class="font-bold mb-1 gt-xs:text-left gt-xs:mr-4 gt-xs:mb-0 w-30"
            >{{ 'product-type.label' | translate }} :
          </span>
          <span class="treo-mat-no-subscript flex-auto gt-xs:mr-4 gt-xs:text-left">{{ product?.productType }}</span>
        </div>
      </div>
      <div class="flex flex-col">
        <div class="flex flex-row">
          <span class="font-bold mb-1 gt-xs:text-left gt-xs:mr-4 gt-xs:mb-0 w-30"
            >{{ 'blood-type.label' | translate }} :
          </span>
          <span class="treo-mat-no-subscript flex-auto gt-xs:mr-4 gt-xs:text-left">{{ product?.bloodType }}</span>
        </div>
      </div>
    </div>
  </mat-card>
</ng-template>
