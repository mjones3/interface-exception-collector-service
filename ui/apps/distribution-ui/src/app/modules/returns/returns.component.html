<div class="flex flex-col flex-auto space-y-1">
  <rsa-process-header
    [subTitle]="header.subTitle$ | async | translate"
    [title]="header.title$ | async | translate"
    [buttons]="actionButtonsTpl"
  >
  </rsa-process-header>

  <div class="w-full flex flex-row space-x-8 p-4">
    <div
      class="flex flex-col"
      [ngClass]="{
        'w-4/6': showExtraFields,
        'w-1/3': !showExtraFields,
        'w-9/12': productSelectionStep
      }"
    >
      <!--STEPPER-->
      <mat-horizontal-stepper linear #stepper (selectionChange)="stepSelectionChange($event)" class="w-full">
        <!-- STEP 1 - Return Information Form -->
        <mat-step [stepControl]="returnOrderGroup" [label]="'return-information.label' | translate">
          <form id="returnInfoForm" [formGroup]="returnOrderGroup" #returnInfoForm="ngForm" rsaGroupErrorMatcher>
            <div class="flex flex-row space-x-6">
              <div
                class="flex flex-col space-y-3"
                [ngClass]="{
                  'w-1/3': showExtraFields,
                  'w-4/5': !showExtraFields
                }"
              >
                <div class="flex flex-row space-x-8">
                  <div class="flex flex-col flex-auto space-y-1">
                    <div class="flex flex-col">
                      <mat-form-field class="flex-auto">
                        <mat-label>{{ 'return-number.label' | translate }}</mat-label>
                        <input
                          id="returnNumber"
                          matInput
                          formControlName="returnNumber"
                          autocomplete="off"
                          [maxLength]="RETURN_NUMBER_MAX_LENGTH"
                        />
                      </mat-form-field>
                    </div>
                  </div>
                </div>
                <div class="flex flex-row space-x-8">
                  <div class="flex flex-col flex-auto space-y-1">
                    <div class="flex flex-col">
                      <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                        <mat-label>{{ 'return-reason.label' | translate }}</mat-label>
                        <mat-select
                          id="returnReason"
                          formControlName="returnReason"
                          required
                          validateOn="touchedState"
                          [placeholder]="'select-an-option.label' | translate"
                          [customErrors]="{
                            required: 'return-reason.label' | validation: validationType.REQUIRED
                          }"
                        >
                          <mat-option *ngFor="let reason of returnReasons" [value]="reason.descriptionKey">
                            {{ reason.descriptionKey | translate }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>
                </div>
                <div class="flex flex-row space-x-8">
                  <div class="flex flex-col flex-auto space-y-1">
                    <div class="flex flex-col">
                      <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                        <mat-label>{{ 'labeling-product-category.label' | translate }}</mat-label>
                        <mat-select
                          id="labelingProductCategoryValue"
                          formControlName="labelingProductCategoryValue"
                          required
                          validateOn="touchedState"
                          [placeholder]="'select-an-option.label' | translate"
                          [customErrors]="{
                            required: 'labeling-product-category.label' | validation: validationType.REQUIRED
                          }"
                          (selectionChange)="labelingProductCategoryChange($event)"
                        >
                          <mat-option *ngFor="let category of productCategories" [value]="category">
                            {{ category.descriptionKey | translate }}
                          </mat-option>
                        </mat-select>
                      </mat-form-field>
                    </div>
                  </div>
                </div>
                <div class="flex flex-row space-x-8">
                  <div class="flex flex-col flex-auto w-1/2">
                    <div class="flex flex-col flex-auto mb-2 space-y-1">
                      <mat-label
                        >{{ 'inspection.label' | translate
                        }}<span class="mat-placeholder-required mat-form-field-required-marker">*</span></mat-label
                      >
                      <div class="flex flex-col mb-4">
                        <mat-radio-group id="inspection" class="flex pt-2" formControlName="inspection">
                          <mat-radio-button
                            *ngFor="let inspection of inspections; let i = index"
                            [id]="'inspection' + i"
                            class="mr-4"
                            [value]="inspection.optionValue"
                            >{{ inspection.descriptionKey | translate }}</mat-radio-button
                          >
                        </mat-radio-group>
                        <rsa-control-error
                          *ngIf="
                            returnOrderGroup.controls.inspection?.touched &&
                            returnOrderGroup.controls.inspection?.errors
                          "
                          [hide]="false"
                          [text]="'inspection.label' | validation: validationType.REQUIRED"
                        ></rsa-control-error>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <!--EXTRA FIELDS-->
              <div class="flex flex-col space-y-3 w-2/3" *ngIf="showExtraFields">
                <rsa-transit-time
                  *ngIf="showTransitTime"
                  [labelingProductCategoryValue]="
                    returnOrderGroup?.controls?.labelingProductCategoryValue?.value?.descriptionKey
                  "
                  [timezones]="timeZones"
                  (transitTimeChanged)="updateTransitTime($event)"
                ></rsa-transit-time>
                <div class="flex flex-row space-x-8">
                  <div class="flex flex-col flex-auto space-y-3">
                    <div class="flex flex-col">
                      <mat-label>{{ 'temperature.label' | translate }}*</mat-label>
                      <div class="flex flex-row flex-auto space-x-2">
                        <div class="flex flex-row">
                          <button
                            id="minusTemperatureBtn"
                            mat-stroked-button
                            type="button"
                            class="mr-0 minusTemperatureBtn"
                            [ngStyle]="{
                              'background-color': selectedSignOfTemperature == '+' ? '#99CD66' : '#4D7229'
                            }"
                            (click)="onToggleTemperature('-')"
                          >
                            -
                          </button>
                          <button
                            id="plusTemperatureBtn"
                            mat-stroked-button
                            type="button"
                            class="ml-0 plusTemperatureBtn"
                            [ngStyle]="{
                              'background-color': selectedSignOfTemperature == '-' ? '#99CD66' : '#4D7229'
                            }"
                            (click)="onToggleTemperature('+')"
                          >
                            +
                          </button>
                        </div>
                        <div class="flex flex-col space-y-2">
                          <mat-form-field appearance="fill" class="block" rsaControlErrorContainer>
                            <input
                              id="temperature"
                              matInput
                              required
                              rsaMaskRegex
                              allowedCharsRegex="[0-9]+"
                              formControlName="temperature"
                              autocomplete="off"
                              validateOn="blur"
                              [customErrors]="{
                                required: 'temperature.label' | validation: validationType.REQUIRED
                              }"
                            />
                            <span matSuffix>{{ 'celsius.label' | translate }}</span>
                          </mat-form-field>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="flex flex-row-reverse mt-2">
              <button
                id="step1NextBtn"
                type="button"
                matStepperNext
                mat-stroked-button
                class="bg-gray-light"
                [disabled]="!returnOrderGroup.valid"
              >
                {{ 'next.label' | translate }}
              </button>
            </div>
          </form>
        </mat-step>

        <!-- STEP 2 - Product Selection -->
        <mat-step [stepControl]="productGroup" [label]="'product-selection.label' | translate">
          <div class="flex flex-row">
            <div class="flex flex-col">
              <form
                id="productSelectionForm"
                [formGroup]="productGroup"
                #productSelectionForm="ngForm"
                rsaGroupErrorMatcher
              >
                <div class="flex flex-row space-x-10 px-8 pt-4">
                  <div class="flex flex-col flex-auto space-y-1">
                    <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                      <mat-label>{{ 'unit-number.label' | translate }}: </mat-label>
                      <input
                        #unitNumberInput
                        matInput
                        id="unitNumber"
                        formControlName="unitNumber"
                        rsaBarcode
                        autocomplete="off"
                        required
                        validateOn="blur"
                        [placeholder]="'scan-unit-number.label' | translate"
                        [customErrors]="{
                          required: 'unit-number.label' | validation: validationType.REQUIRED,
                          invalidUnitNumber: 'unit-number.label' | validation: validationType.INVALID
                        }"
                        (keydown.enter)="onUnitNumberKeyOrTab($event)"
                        (keydown.tab)="onUnitNumberKeyOrTab($event)"
                      />
                    </mat-form-field>
                  </div>

                  <div class="flex flex-col flex-auto space-y-1">
                    <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                      <mat-label>{{ 'product-code.label' | translate }}: </mat-label>
                      <input
                        #productCodeInput
                        matInput
                        id="productCode"
                        formControlName="productCode"
                        rsaFullProductCode
                        autocomplete="off"
                        required
                        validateOn="blur"
                        [placeholder]="'scan-product-code.label' | translate"
                        [customErrors]="{
                          required: 'product-code.label' | validation: validationType.REQUIRED,
                          invalidProductCode: 'product-code.label' | validation: validationType.INVALID
                        }"
                        (keydown.enter)="onProductCodeKeyOrTab()"
                        (keydown.tab)="onProductCodeKeyOrTab()"
                      />
                    </mat-form-field>
                  </div>
                </div>
              </form>

              <!-- RETURNED PRODUCTS -->
              <treo-card class="flex-col m-8 pb-4">
                <!-- Card Title -->
                <div class="treo-card-title">
                  <div class="flex flex-row w-full justify-between items-center px-5">
                    <h3>{{ 'returned-products.label' | translate }}</h3>
                    <button
                      id="removeAllBtn"
                      type="button"
                      mat-raised-button
                      class="bg-purple-light"
                      (click)="removeAll()"
                      *ngIf="products.length"
                    >
                      {{ 'remove-all.label' | translate }}
                    </button>
                  </div>
                </div>
                <mat-divider></mat-divider>
                <div class="table-wrapper">
                  <p-table
                    #productTable
                    id="productTableId"
                    dataKey="inventoryId"
                    styleClass="p-datatable-customers p-datatable-sm"
                    currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                    [showCurrentPageReport]="true"
                    [value]="products"
                    [rows]="10"
                    [rowsPerPageOptions]="[10, 25, 50]"
                    [paginator]="true"
                    [loading]="loading"
                  >
                    <ng-template pTemplate="header">
                      <tr>
                        <th class="pl-6">
                          <div class="p-d-flex p-jc-between p-ai-center">
                            {{ 'unit-number.label' | translate }}
                          </div>
                        </th>
                        <th>
                          <div class="p-d-flex p-jc-between p-ai-center">
                            {{ 'product-code.label' | translate }}
                          </div>
                        </th>
                        <th *ngIf="rareDonorExists">
                          <div class="p-d-flex p-jc-between p-ai-center">
                            {{ 'rare-donor.label' | translate }}
                          </div>
                        </th>
                        <th *ngIf="quarantineExists">
                          <div class="p-d-flex p-jc-between p-ai-center">
                            {{ 'quarantine.label' | translate }}
                          </div>
                        </th>
                        <th></th>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-product let-expanded="expanded" let-i="rowIndex">
                      <tr>
                        <td class="pl-6">{{ product.unitNumber }}</td>
                        <td>{{ product.isbtProductCode }}</td>
                        <td *ngIf="rareDonorExists">
                          <div class="flex flex-row text-custom-green" *ngIf="product.rareDonor">
                            <mat-icon [svgIcon]="'done_all'"></mat-icon>
                          </div>
                        </td>
                        <td *ngIf="quarantineExists">
                          <div
                            class="flex flex-row text-custom-red"
                            *ngIf="consequences?.length || product.quarantined"
                          >
                            <mat-icon [svgIcon]="'done_all'"></mat-icon>
                          </div>
                        </td>
                        <td class="text-right pr-5">
                          <button
                            id="removeBtn"
                            type="button"
                            mat-raised-button
                            class="bg-purple-light"
                            [pRowToggler]="product"
                            (click)="removeProd(i)"
                          >
                            {{ 'remove.label' | translate }}
                          </button>
                        </td>
                      </tr>
                    </ng-template>
                    <ng-template pTemplate="footer">
                      <tr>
                        <td
                          [attr.colspan]="
                            rareDonorExists && quarantineExists ? 5 : rareDonorExists || quarantineExists ? 4 : 3
                          "
                          class="p-text-right"
                        >
                          <span class="ml-6"
                            >({{ products.length }}) {{ 'products-ready-to-be-returned.label' | translate }}</span
                          >
                        </td>
                      </tr>
                    </ng-template>
                  </p-table>
                </div>
              </treo-card>

              <div class="flex flex-row-reverse m-4">
                <button
                  id="submitBtn"
                  type="button"
                  mat-stroked-button
                  class="bg-success ml-2"
                  (click)="onClickSubmit()"
                  [disabled]="!returnOrderGroup.valid || !products.length"
                >
                  {{ 'submit.label' | translate }}
                </button>
                <button
                  id="backBtn"
                  type="button"
                  mat-stroked-button
                  class="background-color"
                  (click)="step2BackClick()"
                >
                  {{ 'back.label' | translate }}
                </button>
              </div>
            </div>
          </div>
        </mat-step>
      </mat-horizontal-stepper>

      <!--COMMENT-->
      <div class="w-full flex pt-4">
        <mat-card class="w-full">
          <form id="commentInfoForm" [formGroup]="commentForm">
            <div class="flex flex-col flex-auto space-y-1">
              <mat-form-field appearance="fill" class="flex-auto w-full">
                <mat-label class="block font-bold min-w-60">{{ 'comment.label' | translate }}</mat-label>
                <textarea
                  formControlName="comments"
                  id="commentsTextArea"
                  matInput
                  cdkTextareaAutosize
                  [maxLength]="RETURN_COMMENTS_MAX_LENGTH"
                  [cdkAutosizeMinRows]="3"
                ></textarea>
              </mat-form-field>
            </div>
          </form>
        </mat-card>
      </div>
    </div>
    <!--WIDGET-->
    <div class="flex flex-col flex-auto w-3/12" *ngIf="productSelectionStep">
      <rsa-common-widget
        [color]="'#E25063'"
        [hasBorder]="true"
        [title]="returnInfoWidgetTitle"
        [subtitle]="returnInfoWidgetSubtitle"
        [templateRef]="widgetInformationContent"
      >
        <ng-template #widgetInformationContent>
          <div class="flex flex-col">
            <rsa-description-card
              [descriptions]="returnInformation"
              [embedded]="true"
              [maxCols]="1"
              [labelClasses]="'w-30'"
            ></rsa-description-card>
          </div>
        </ng-template>
      </rsa-common-widget>
    </div>
  </div>
</div>

<ng-template #actionButtonsTpl>
  <div class="flex flex-row space-x-2">
    <button id="cancelBtn" class="primary" mat-stroked-button (click)="cancel()">
      {{ 'cancel.label' | translate }}
    </button>
  </div>
</ng-template>
