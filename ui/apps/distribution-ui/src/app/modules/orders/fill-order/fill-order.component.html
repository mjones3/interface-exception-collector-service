<div class="flex flex-col flex-auto space-y-1">
  <rsa-process-header
    [subTitle]="header.subTitle$ | async | translate"
    [title]="header.title$ | async | translate"
    [buttons]="actionButtonsTpl"
  ></rsa-process-header>

  <div class="w-full flex flex-row space-x-8 p-4">
    <div class="flex flex-col flex-auto space-y-3 w-9/12">
      <treo-card class="flex flex-row space-x-6 items-center p-6">
        <div class="flex flex-row space-x-2">
          <span class="text-left font-bold">{{ 'quantity.label' | translate }}:</span>
          <span class="text-left font-bold">{{
            '(' + products?.length + ' ' + ('of.label' | translate) + ' ' + quantity + ')'
          }}</span>
        </div>
        <div class="flex flex-col flex-auto">
          <mat-progress-bar
            id="productsFilledProgressBar"
            class="h-2"
            mode="determinate"
            [value]="((products?.length || 0) / quantity) * 100"
          ></mat-progress-bar>
        </div>
      </treo-card>
      <div class="flex flex-col flex-grow-0">
        <rsa-description-card
          [descriptions]="prodInfoDescriptions"
          [labelClasses]="'min-w-40'"
          [showColon]="true"
          [embedded]="true"
          [maxRows]="2"
          [image]="prodIcon"
        ></rsa-description-card>
      </div>

      <treo-card class="flex flex-col p-4" *ngIf="checkForUnlicensedProducts">
        <div class="mb-4 text-left">
          <a
            [id]="'document' + i"
            *ngFor="let document of documentsFiles; let i = index"
            (click)="openDocument(document.id, document.filename)"
            class="flex items-center mb-1 document-content"
          >
            <mat-icon class="document-icon flex-shrink-0" [svgIcon]="getIconType(document.filename)"></mat-icon>
            <div class="ml-2">{{ document.filename }}</div>
          </a>
        </div>
        <rsa-common-upload-document
          [downloadLocalDocument]="true"
          [showEmptyValidation]="false"
          [showTitlesWhenEmpty]="false"
          [addDocumentLabel]="'add-medical-need-form.label'"
          (uploadedFilesChanged)="updateFiles($event)"
          (documentsFormData)="getFormData($event)"
        ></rsa-common-upload-document>
      </treo-card>
      <treo-card class="flex flex-col space-y-4 flex-auto">
        <rsa-product-selection
          #productSelectionComponent
          [orderProductId]="orderProduct?.id"
          [currentOrder]="currentOrder"
          (updateLoadingState)="loading = $event"
          [shouldProceedWithProductSelection]="shouldProceedWithProductSelection"
          (unitNumberProductCodeSelected)="unitNumberProductCodeSelected($event.unitNumber, $event.productCode)"
        ></rsa-product-selection>

        <treo-card class="flex-col m-8 pb-4">
          <div class="treo-card-title">
            <div class="flex flex-row w-full justify-between items-center px-5">
              <h3>{{ 'filled-products.label' | translate }}</h3>
              <button
                id="removeAllBtn"
                type="button"
                mat-raised-button
                class="bg-purple-light"
                (click)="removeAll()"
                *ngIf="products?.length && !orderShipped"
              >
                {{ 'remove-all.label' | translate }}
              </button>
            </div>
          </div>
          <mat-divider></mat-divider>

          <div class="table-wrapper" *ngIf="products?.length">
            <p-table
              #productTable
              id="prodTableId"
              dataKey="id"
              styleClass="p-datatable-customers p-datatable-sm"
              [value]="products"
              [loading]="loading"
            >
              <ng-template pTemplate="header">
                <tr>
                  <th class="w-8"></th>
                  <th>
                    <div class="p-d-flex p-jc-between p-ai-center">
                      {{ 'unit-number.label' | translate }}
                    </div>
                  </th>
                  <th>
                    <div class="p-d-flex p-jc-between p-ai-center">
                      {{ 'product-code.label' | translate }}
                    </div>
                  </th>
                  <th>
                    <div class="p-d-flex p-jc-between p-ai-center">
                      {{ 'description.label' | translate }}
                    </div>
                  </th>
                  <th *ngIf="priceOverrideVisible">
                    <div class="p-d-flex p-jc-between p-ai-center">
                      {{ 'price-override.label' | translate }}
                    </div>
                  </th>
                  <th *ngIf="checkForUnlicensedProducts">
                    <div class="p-d-flex p-jc-between p-ai-center">
                      {{ 'unlicensed-product.label' | translate }}
                    </div>
                  </th>
                  <th></th>
                </tr>
              </ng-template>
              <ng-template pTemplate="body" let-product let-i="rowIndex">
                <tr>
                  <td></td>
                  <td>
                    {{ product?.unitNumber }}
                  </td>
                  <td>
                    {{ product?.productCode }}
                  </td>
                  <td>
                    {{ product?.description | translate }}
                  </td>
                  <td *ngIf="priceOverrideVisible">
                    <div class="flex flex-row space-x-2 items-center">
                      <mat-checkbox
                        class="mb-1"
                        #priceOverrideCheck
                        [id]="'priceOverrideCheck' + i"
                        [color]="'primary'"
                      ></mat-checkbox>
                      <mat-form-field>
                        <input
                          id="priceOverride"
                          matInput
                          autocomplete="off"
                          rsaMaskRegex
                          allowedCharsRegex="[0-9,.]+"
                          [disabled]="!priceOverrideCheck.checked"
                          [ngModel]="product?.orderItemInventory?.price"
                          (ngModelChange)="priceChange($event, product)"
                        />
                      </mat-form-field>
                    </div>
                  </td>
                  <td *ngIf="checkForUnlicensedProducts">
                    <div class="flex flex-row items-center text-unlicensed-prod" *ngIf="product?.unlicensed">
                      <mat-icon [svgIcon]="'dripicons:to-do'"></mat-icon>
                    </div>
                  </td>
                  <td>
                    <button
                      id="removeBtn"
                      type="button"
                      mat-raised-button
                      class="bg-purple-light"
                      (click)="removeProd(i)"
                      *ngIf="!orderShipped"
                    >
                      {{ 'remove.label' | translate }}
                    </button>
                  </td>
                </tr>
              </ng-template>
              <ng-template pTemplate="footer">
                <tr>
                  <td [attr.colspan]="checkForUnlicensedProducts ? 7 : 6" class="p-text-right">
                    <span class="ml-6">({{ products.length }}) {{ 'total-components.label' | translate }}</span>
                  </td>
                </tr>
              </ng-template>
            </p-table>
          </div>
        </treo-card>
      </treo-card>
    </div>
    <div class="flex flex-col flex-auto w-3/12">
      <rsa-order-widget-sidebar
        [feesInfoDescriptions]="feesInfoDescriptions"
        [billInfoDescriptions]="billInfoDescriptions"
        [orderInfoDescriptions]="orderInfoDescriptions"
        [shippingInfoDescriptions]="shippingInfoDescriptions"
        [comments]="currentOrder?.comments"
      ></rsa-order-widget-sidebar>
    </div>
  </div>
</div>

<ng-template #actionButtonsTpl>
  <div class="flex flex-row space-x-2">
    <button id="cancelBtnId" class="primary" mat-stroked-button (click)="cancel()">
      {{ 'cancel.label' | translate }}
    </button>
    <button id="saveBtn" class="primary" [disabled]="cantSave" mat-stroked-button (click)="save()">
      {{ 'save.label' | translate }}
    </button>
  </div>
</ng-template>

<ng-template #optionDescriptionTpl>
  <div class="flex flex-col space-y-3">
    <div>
      <span class="font-bold mr-2">{{ 'unit-number.label' | translate }}:</span>
      <span>{{ productGroup.get('unitNumber')?.value }}</span>
    </div>
    <div>{{ 'please-select-product.label' | translate }}.</div>
  </div>
</ng-template>
