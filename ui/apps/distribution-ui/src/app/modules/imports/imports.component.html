<div class="flex flex-col flex-auto space-y-1">
  <rsa-process-header
    [subTitle]="header.subTitle$ | async | translate"
    [title]="header.title$ | async | translate"
    [buttons]="actionButtonsTpl"
  ></rsa-process-header>

  <div class="w-full flex flex-row space-x-8 p-4">
    <div
      class="flex flex-col"
      [ngClass]="{
        'w-8/12': !productSelectionStep,
        'w-9/12': productSelectionStep
      }"
    >
      <!-- STEPPER -->
      <mat-horizontal-stepper linear #stepper (selectionChange)="stepSelectionChange($event)" class="w-full">
        <!-- STEP 1 - Shipment Information Form -->
        <mat-step [stepControl]="importsGroup" [label]="'shipment-information.label' | translate">
          <form id="shipmentInformation" [formGroup]="importsGroup" #importInfoForm="ngForm" rsaGroupErrorMatcher>
            <div class="flex flex-col space-y-3 w-full">
              <div class="flex flex-row space-x-8">
                <div class="flex flex-col flex-auto space-y-1">
                  <div class="flex flex-col">
                    <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                      <mat-label>{{ 'labeling-product-category.label' | translate }}</mat-label>
                      <mat-select
                        id="labelingProductCategoryValue"
                        formControlName="labelingProductCategoryValue"
                        required
                        validateOn="touchedState"
                        [placeholder]="'select-an-option.label' | translate"
                        (selectionChange)="labelingProductCategoryChange($event)"
                        [customErrors]="{
                          required: 'labeling-product-category.label' | validation: validationType.REQUIRED
                        }"
                      >
                        <mat-option *ngFor="let category of productCategories" [value]="category">{{
                          category.descriptionKey | translate
                        }}</mat-option>
                      </mat-select>
                    </mat-form-field>
                  </div>
                </div>
              </div>
              <!--EXTRA FIELDS-->
              <div class="flex flex-col space-y-3" *ngIf="showExtraFields">
                <rsa-transit-time
                  *ngIf="showTransitTime"
                  [labelingProductCategoryValue]="
                    importsGroup?.controls?.labelingProductCategoryValue?.value?.descriptionKey
                  "
                  [timezones]="timeZones"
                  (transitTimeChanged)="updateTransitTime($event)"
                ></rsa-transit-time>
                <div class="flex flex-row space-x-8">
                  <div class="flex flex-col flex-auto space-y-1">
                    <div class="flex flex-col">
                      <mat-label>{{ 'temperature.label' | translate }}*</mat-label>
                      <div class="flex flex-row flex-auto space-x-2">
                        <div class="flex flex-row">
                          <button
                            id="minusTemperatureBtn"
                            mat-stroked-button
                            type="button"
                            class="mr-0 minusTemperatureBtn"
                            [ngStyle]="{
                              'background-color': selectedSignOfTemperature == '+' ? '#99CD66' : '#4D7229'
                            }"
                            (click)="onToggleTemperature('-')"
                          >
                            -
                          </button>
                          <button
                            id="plusTemperatureBtn"
                            mat-stroked-button
                            type="button"
                            class="ml-0 plusTemperatureBtn"
                            [ngStyle]="{
                              'background-color': selectedSignOfTemperature == '-' ? '#99CD66' : '#4D7229'
                            }"
                            (click)="onToggleTemperature('+')"
                          >
                            +
                          </button>
                        </div>
                        <div class="flex flex-col space-y-2">
                          <mat-form-field appearance="fill" class="block" rsaControlErrorContainer>
                            <input
                              id="temperature"
                              matInput
                              required
                              rsaMaskRegex
                              allowedCharsRegex="[0-9]+"
                              formControlName="temperature"
                              autocomplete="off"
                              validateOn="blur"
                              [customErrors]="{
                                required: 'temperature.label' | validation: validationType.REQUIRED
                              }"
                            />
                            <span matSuffix>{{ 'celsius.label' | translate }}</span>
                          </mat-form-field>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex flex-row space-x-8">
                <div class="flex flex-col flex-auto w-1/2">
                  <div class="flex flex-col flex-auto mb-2 space-y-1">
                    <mat-label
                      >{{ 'inspection.label' | translate
                      }}<span class="mat-placeholder-required mat-form-field-required-marker">*</span></mat-label
                    >
                    <div class="flex flex-col mb-4">
                      <mat-radio-group id="inspection" class="flex pt-2" formControlName="inspection">
                        <mat-radio-button
                          *ngFor="let inspection of inspections; let i = index"
                          [id]="'inspection' + i"
                          class="mr-4"
                          [value]="inspection.optionValue"
                          >{{ inspection.descriptionKey | translate }}</mat-radio-button
                        >
                      </mat-radio-group>
                      <rsa-control-error
                        *ngIf="importsGroup.controls.inspection?.touched && importsGroup.controls.inspection?.errors"
                        [hide]="false"
                        [text]="'inspection.label' | validation: validationType.REQUIRED"
                      ></rsa-control-error>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="flex flex-row-reverse mt-2">
              <button
                id="step1NextBtn"
                mat-stroked-button
                matStepperNext
                class="bg-gray-light"
                [disabled]="!importsGroup.valid"
              >
                {{ 'next.label' | translate }}
              </button>
            </div>
          </form>
        </mat-step>

        <!-- STEP 2 - Product Selection -->
        <mat-step [stepControl]="productGroup" [label]="'product-selection.label' | translate">
          <form [formGroup]="productGroup" class="mt-3" #productSelectionForm="ngForm" rsaGroupErrorMatcher>
            <div class="flex flex-col">
              <!--SCAN FIELDS-->
              <div class="flex flex-row space-x-10 px-8 pt-4">
                <div class="flex flex-col flex-auto space-y-1 input-with-validation">
                  <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                    <mat-label>{{ 'unit-number.label' | translate }}:</mat-label>
                    <input
                      matInput
                      id="unitNumber"
                      formControlName="unitNumber"
                      rsaBarcode
                      autocomplete="off"
                      required
                      validateOn="blur"
                      tabindex="0"
                      #controlErrorsDirective="controlError"
                      [placeholder]="'scan-unit-number.label' | translate"
                      [customErrors]="{
                        required: 'unit-number.label' | validation: validationType.REQUIRED,
                        invalidUnitNumber: 'unit-number.label' | validation: validationType.INVALID
                      }"
                      [(rsaAutoFocusIf)]="unitNumberFocus"
                      (keydown.enter)="onUnitNumberKeyOrTab($event)"
                      (keydown.tab)="onUnitNumberKeyOrTab($event)"
                    />
                  </mat-form-field>
                </div>
                <div class="flex flex-col flex-auto space-y-1 input-with-validation">
                  <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                    <mat-label>{{ 'blood-type.label' | translate }}:</mat-label>
                    <input
                      id="bloodType"
                      formControlName="aboRh"
                      required
                      matInput
                      validateOn="blur"
                      tabindex="1"
                      [placeholder]="'scan-blood-type.label' | translate"
                      [customErrors]="{
                        required: 'blood-type.label' | validation: validationType.REQUIRED,
                        invalid: 'blood-type.label' | validation: validationType.INVALID
                      }"
                      [matAutocomplete]="bloodTypeAuto"
                      [(rsaAutoFocusIf)]="aboRhFocus"
                      (keydown.enter)="onBloodTypeKeyOrTab($event)"
                      (keydown.tab)="onBloodTypeKeyOrTab($event)"
                    />
                    <mat-autocomplete #bloodTypeAuto="matAutocomplete" [displayWith]="displayBloodTypeFn">
                      <mat-option
                        *ngFor="let option of filteredBloodTypes | async"
                        [value]="option"
                        (onSelectionChange)="onBloodTypeKeyOrTab()"
                      >
                        {{ option.descriptionKey | translate }}
                      </mat-option>
                    </mat-autocomplete>
                  </mat-form-field>
                </div>
                <div class="flex flex-col flex-auto space-y-1 input-with-validation">
                  <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                    <mat-label>{{ 'product-code.label' | translate }}:</mat-label>
                    <input
                      matInput
                      id="productCode"
                      formControlName="productCode"
                      rsaFullProductCode
                      autocomplete="off"
                      required
                      validateOn="blur"
                      tabindex="2"
                      [placeholder]="'scan-product-code.label' | translate"
                      [customErrors]="{
                        required: 'product-code.label' | validation: validationType.REQUIRED,
                        invalidProductCode: 'product-code.label' | validation: validationType.INVALID
                      }"
                      [(rsaAutoFocusIf)]="productCodeFocus"
                      (keydown.enter)="onProductCodeKeyOrTab($event)"
                      (keydown.tab)="onProductCodeKeyOrTab($event)"
                    />
                  </mat-form-field>
                </div>
                <div class="flex flex-col flex-auto space-y-1 input-with-validation">
                  <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                    <mat-label>{{ 'expiration-date.label' | translate }}:</mat-label>
                    <input
                      id="expirationDate"
                      formControlName="expirationDate"
                      required
                      matInput
                      placeholder="MM/DD/YYYY"
                      validateOn="blur"
                      tabindex="3"
                      autocomplete="off"
                      [customErrors]="{
                        required: 'expiration-date.label' | validation: validationType.REQUIRED,
                        invalidDate: 'expiration-date.label' | validation: validationType.INVALID
                      }"
                      [(rsaAutoFocusIf)]="expirationDateFocus"
                      (keydown.enter)="onExpirationDateKeyOrTab($event)"
                      (keydown.tab)="onExpirationDateKeyOrTab($event)"
                    />
                  </mat-form-field>
                </div>
              </div>

              <!--PRODUCT ATTRIBUTES-->
              <div class="flex flex-row space-x-10 px-8 p-4">
                <div class="flex flex-col flex-auto space-y-4">
                  <mat-label>{{ 'license-status.label' | translate }}</mat-label>
                  <mat-radio-group id="licenseRadioGroup" formControlName="licenseStatus">
                    <mat-radio-button id="licensedRadioBtn" [value]="licensed" class="mr-2">{{
                      'licensed.label' | translate
                    }}</mat-radio-button>
                    <mat-radio-button id="unlicensedRadioBtn" [value]="unlicensed">{{
                      'unlicensed.label' | translate
                    }}</mat-radio-button>
                  </mat-radio-group>
                </div>

                <div class="flex flex-col flex-auto space-y-4">
                  <mat-label>{{ 'cmv-status.label' | translate }}</mat-label>
                  <mat-radio-group id="cmvStatusRadioGroup" formControlName="cmvStatus">
                    <mat-radio-button id="cmvNegativeRadioBtn" value="cmv-negative.label" class="mr-2">{{
                      'cmv-negative.label' | translate
                    }}</mat-radio-button>
                    <mat-radio-button id="cmvPositiveRadioBtn" value="cmv-positive.label">{{
                      'cmv-positive.label' | translate
                    }}</mat-radio-button>
                  </mat-radio-group>
                </div>

                <div class="flex flex-auto space-y-4 items-end">
                  <div class="flex flex-col">
                    <mat-checkbox id="hsbNegativeCheckbox" formControlName="hsbNegative">{{
                      'hbs-negative.label' | translate
                    }}</mat-checkbox>
                  </div>
                </div>

                <!--ADD PRODUCT BUTTON-->
                <div class="flex flex-auto justify-end items-end">
                  <button
                    id="addProductBtn"
                    class="bg-success"
                    mat-stroked-button
                    *ngIf="addProductVisible"
                    (click)="addProduct()"
                  >
                    {{ 'add.label' | translate }}
                  </button>
                </div>
              </div>
              <!--REGISTRATION NUMBER-->
              <div class="flex flex-row space-x-10 px-8 p-4" *ngIf="registrationNumberNeeded">
                <div class="w-1/5">
                  <mat-form-field appearance="fill" class="block w-full" rsaControlErrorContainer>
                    <mat-label>{{ 'registration-number.label' | translate }}</mat-label>
                    <mat-select
                      id="registrationNumber"
                      formControlName="registrationNumber"
                      required
                      validateOn="touchedState"
                      [placeholder]="'select-an-option.label' | translate"
                      [customErrors]="{
                        required: 'registration-number.label' | validation: validationType.REQUIRED
                      }"
                    >
                      <mat-option *ngFor="let importFacility of importFacilities" [value]="importFacility.id">{{
                        importFacility.registrationNumber
                      }}</mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </form>

          <!--IMPORTED PRODUCTS TABLE-->
          <treo-card class="flex-col m-8 pb-4">
            <!-- Card Title -->
            <div class="treo-card-title">
              <div class="flex flex-row w-full justify-between items-center px-5">
                <h3>{{ 'imported-products.label' | translate }}</h3>
                <button
                  id="removeAllBtn"
                  type="button"
                  mat-raised-button
                  class="bg-purple-light"
                  (click)="removeAll()"
                  *ngIf="importedProducts.length"
                >
                  {{ 'remove-all.label' | translate }}
                </button>
              </div>
            </div>
            <mat-divider></mat-divider>
            <div class="table-wrapper">
              <p-table
                #productTable
                id="productTableId"
                dataKey="id"
                styleClass="p-datatable-customers p-datatable-sm"
                currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
                [showCurrentPageReport]="true"
                [value]="importedProducts"
                [rows]="10"
                [rowsPerPageOptions]="[10, 25, 50]"
                [paginator]="true"
                [loading]="loading"
              >
                <ng-template pTemplate="header">
                  <tr>
                    <th class="w-12"></th>
                    <th>
                      <div class="p-d-flex p-jc-between p-ai-center">
                        {{ 'unit-number.label' | translate }}
                      </div>
                    </th>
                    <th>
                      <div class="p-d-flex p-jc-between p-ai-center">
                        {{ 'blood-type.label' | translate }}
                      </div>
                    </th>
                    <th>
                      <div class="p-d-flex p-jc-between p-ai-center">
                        {{ 'product-code.label' | translate }}
                      </div>
                    </th>
                    <th>
                      <div class="p-d-flex p-jc-between p-ai-center">
                        {{ 'product-short-description.label' | translate }}
                      </div>
                    </th>
                    <th>
                      <div class="p-d-flex p-jc-between p-ai-center">
                        {{ 'expiration-date.label' | translate }}
                      </div>
                    </th>
                    <th *ngIf="patientRecordNeeded">
                      <div class="p-d-flex p-jc-between p-ai-center">
                        {{ 'patient-record.label' | translate }}
                      </div>
                    </th>
                    <th></th>
                  </tr>
                </ng-template>
                <ng-template pTemplate="body" let-importedProduct let-expanded="expanded">
                  <tr>
                    <td [ngStyle]="{ width: '30px' }">
                      <button
                        id="expandRowBtn"
                        type="button"
                        pButton
                        pRipple
                        class="p-button-text p-button-rounded p-button-plain"
                        *ngIf="importedProduct?.itemAttributes?.length"
                        [pRowToggler]="importedProduct"
                        [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
                      ></button>
                    </td>
                    <td>{{ importedProduct.unitNumber }}</td>
                    <td>
                      {{ getLookUpDescriptionKey(importedProduct.bloodType, bloodTypes) | translate | uppercase }}
                    </td>
                    <td>{{ importedProduct.isbtProductCode }}</td>
                    <td>{{ importedProduct.descriptionKey | translate | uppercase }}</td>
                    <td>{{ importedProduct.expirationDate | date: 'MM/dd/yyyy' }}</td>
                    <td *ngIf="patientRecordNeeded">
                      <div *ngIf="importedProduct.patientRecord" class="flex flex-row space-x-2">
                        <mat-icon [svgIcon]="'rsa:patient-record'" class="product-icon"></mat-icon>
                        <a class="link" (click)="patientSearch(importedProduct)">{{
                          (importedProduct.patient ? 'edit.label' : 'add.label') | translate
                        }}</a>
                      </div>
                    </td>
                    <td class="text-right pr-5">
                      <button
                        id="removeBtn"
                        type="button"
                        mat-raised-button
                        class="bg-purple-light"
                        (click)="removeProd(i)"
                      >
                        {{ 'remove.label' | translate }}
                      </button>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="rowexpansion" let-importedProduct>
                  <tr>
                    <td [attr.colspan]="patientRecordNeeded ? 8 : 7">
                      <div class="p-4">
                        <div class="flex flex-row space-x-2">
                          <span class="badge" *ngFor="let attr of importedProduct?.itemAttributes">{{
                            convertAttributeValue(attr) | translate | uppercase
                          }}</span>
                        </div>
                      </div>
                    </td>
                  </tr>
                </ng-template>
                <ng-template pTemplate="footer">
                  <tr>
                    <td [attr.colspan]="patientRecordNeeded ? 8 : 7" class="p-text-right">
                      <span class="ml-6"
                        >({{ importedProducts?.length }}) {{ 'products-ready-to-be-imported.label' | translate }}</span
                      >
                    </td>
                  </tr>
                </ng-template>
              </p-table>
            </div>
          </treo-card>

          <div class="flex flex-row-reverse m-4">
            <button
              id="completeBtn"
              mat-stroked-button
              class="bg-success ml-2"
              (click)="complete()"
              [disabled]="isCompleteDisabled"
            >
              {{ 'complete.label' | translate }}
            </button>
            <button id="backBtn" mat-stroked-button class="background-color" (click)="step2BackClick()">
              {{ 'back.label' | translate }}
            </button>
          </div>
        </mat-step>
      </mat-horizontal-stepper>

      <!--COMMENT-->
      <div class="w-full flex pt-4">
        <mat-card class="w-full">
          <form id="commentInfoForm" [formGroup]="commentForm">
            <div class="flex flex-col flex-auto space-y-1">
              <mat-form-field appearance="fill" class="flex-auto w-full">
                <mat-label class="block font-bold min-w-60">{{ 'comment.label' | translate }}</mat-label>
                <textarea
                  formControlName="comments"
                  id="commentsId"
                  matInput
                  cdkTextareaAutosize
                  [maxLength]="COMMENTS_MAX_LENGTH"
                  [cdkAutosizeMinRows]="3"
                ></textarea>
              </mat-form-field>
            </div>
          </form>
        </mat-card>
      </div>
    </div>

    <!--WIDGET-->
    <div class="flex flex-col flex-auto w-3/12" *ngIf="productSelectionStep">
      <rsa-common-widget
        [color]="'#E25063'"
        [hasBorder]="true"
        [title]="importInfoWidgetTitle"
        [subtitle]="importInfoWidgetSubtitle"
        [templateRef]="widgetInformationContent"
      >
        <ng-template #widgetInformationContent>
          <div class="flex flex-col">
            <rsa-description-card
              [descriptions]="importInformation"
              [embedded]="true"
              [maxCols]="1"
            ></rsa-description-card>
          </div>
        </ng-template>
      </rsa-common-widget>
    </div>
  </div>
</div>

<ng-template #actionButtonsTpl>
  <div class="flex flex-row space-x-2">
    <button id="cancelBtn" class="primary" mat-stroked-button (click)="cancel()">
      {{ 'cancel.label' | translate }}
    </button>
  </div>
</ng-template>
