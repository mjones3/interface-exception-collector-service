<div class="flex flex-col flex-auto space-y-1">
    <rsa-process-header
      [subTitle]="header.subTitle | async "
      [title]="header.title | async "
      [buttons]="actionButtonsTpl"
    ></rsa-process-header>


    <div class="w-full flex flex-row space-x-8 p-4">
      <div class="flex flex-col flex-auto w-9/12">
        <fuse-card class="flex flex-row space-x-6 items-center p-6" *ngIf="!isProductComplete">
          <div class="flex flex-row space-x-2">
            <span class="text-left font-bold">
              (<span id="filledProductsCount">{{ filledProductsCount }}</span> Of
              <span id="totalProducts">{{ totalProducts }}</span
              >)
            </span>
            <span class="text-left font-bold"> Filled Product</span>
            <span class="text-left font-bold" id="percentageId">{{ filledProductsCount / totalProducts | percent }}</span>
          </div>
          <div class="flex flex-col flex-auto">
            <mat-progress-bar
              id="shipmentProgressBarId"
              class="h-2"
              mode="determinate"
              [value]="(filledProductsCount / totalProducts) * 100"
            ></mat-progress-bar>
          </div>
        </fuse-card> 

        <div class="flex flex-col space-y-3 mb-6">
          <div class="flex flex-col">
            <ng-container *ngTemplateOutlet="addedProductTpl; context: { review: true }"></ng-container>
          </div>
        </div>

      </div>

      <div class="flex flex-col flex-auto w-1/4">
        <rsa-order-widget-sidebar
          [orderInfoDescriptions]="orderInfoDescriptions"
          [shippingInfoDescriptions]="shippingInfoDescriptions"
        ></rsa-order-widget-sidebar>
      </div>
    </div>
</div>

<ng-template #actionButtonsTpl>
  <div class="flex flex-row space-x-2">
    <button id="backBtnId" class="primary" mat-stroked-button (click)="backToSearch()">
      Back
    </button>
  </div>
</ng-template>


<ng-template #addedProductTpl let-review="review">
  <div class="flex flex-row justify-between items-end my-4">
    <div class="flex flex-row">
      <span class="mb-1 text-left font-bold mr-4 w-60">Labeling Product Category:</span>
      <span class="flex-auto text-left">{{ labelingProductCategory | uppercase }}</span>
    </div> 
  </div>     
  
  <!--Shipment Details Table-->
 <div class="flex flex-col flex-auto space-y-1">
  <fuse-card class="flex-col pb-4">
    <!-- Header Section -->
    <div class="fuse-card-title">
      <div class="flex flex-row w-full justify-between px-5 items-baseline">
        <h3> Product Details</h3>
      </div>
    </div>
    <mat-divider></mat-divider>

    <div class="table-wrapper">
      <p-table
        id="prodTableId"
        dataKey="id"
        styleClass="p-datatable-customers p-datatable-sm"
        currentPageReportTemplate="Showing {first} to {last} of {totalRecords} entries"
        sortField="productFamily.descriptionKey"
        [customSort]="true"
        [value]="products"
        [rows]="10"
        [showCurrentPageReport]="true"
        [rowsPerPageOptions]="[10, 25, 50]"
        [paginator]="true"
        [loading]="loading"
        [expandedRowKeys]="expandedRows"
      >
        <ng-template pTemplate="header">
          <tr>
            <th class="w-12"></th>
            <th class="w-12"></th>
            <th id="productFamilyColumn" pSortableColumn="productFamily" >
              <div class="p-d-flex p-jc-between p-ai-center flex items-center">
                Product Family
                <p-sortIcon field="productFamily"></p-sortIcon>
              </div>
            </th>
            <th id="quantityColumn" pSortableColumn="quantity">
              <div class="p-d-flex p-jc-between p-ai-center flex items-center">
                Quantity
                <p-sortIcon field="quantity"></p-sortIcon>
              </div>
            </th>
            <th >
              <div pSortableColumn="quantityFilledProducts" class="p-d-flex p-jc-between p-ai-center flex items-center">
                Filled
                <p-sortIcon field="quantityFilledProducts"></p-sortIcon>
              </div>
            </th>
            <th id="bloodTypeColumn" pSortableColumn="bloodType">
              <div class="p-d-flex p-jc-between p-ai-center flex items-center">
               Blood Type
                <p-sortIcon field="bloodType"></p-sortIcon>
              </div>
            </th>
            <th></th>
          </tr>
        </ng-template>
        <ng-template pTemplate="body" let-product let-expanded="expanded" let-i="rowIndex">
          <tr>
            <td [ngStyle]="{ width: '30px' }">
              <div class="flex-row space-x-4 justify-center">
                <button
                id="expandRowBtn"
                type="button"
                class="p-button-text p-button-rounded p-button-plain"
                pButton
                pRipple
                *ngIf="product?.comments"
                [pRowToggler]="product"
                [icon]="expanded ? 'pi pi-chevron-down' : 'pi pi-chevron-right'"
              ></button>
              </div>
            </td>
            <td>
              <mat-icon [svgIcon]="getIcon(product?.productFamily)" class="product-icon"></mat-icon>
            </td>
            <td>
              {{ product?.productFamily | uppercase }}
            </td>
            <td>
              {{ product?.quantity }}
            </td>
            <td>
              <div class="flex flex-row items-center justify-start space-x-2">
                <span>{{ product?.packedItems?.length || 0 }}</span>
                <span class="w-10">
                  <mat-progress-bar
                    mode="determinate"
                    [id]="'filled' + i"
                    [value]="((product?.packedItems?.length || 0) / product?.quantity) * 100"
                  ></mat-progress-bar
                ></span>
                <mat-icon
                  class="text-custom-green"
                  [svgIcon]="'hi_outline:clock'"
                  *ngIf="product?.packedItems?.length"
                ></mat-icon>
              </div>
            </td>
            <td>
              {{ product?.bloodType | uppercase }}
            </td>
            <td>
              <div
                *ngIf="product?.packedItems?.length !== product?.quantity && !isProductComplete"
                class="flex flex-row space-x-4 justify-center"
              >
                <button
                  [id]="'fillShipmentBtn' + i"
                  mat-stroked-button
                  class="bg-custom-red"
                  (click)="fillProducts(product)"
                >
                  Fill Product
                </button>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="rowexpansion" let-product>
          <tr>
            <td [attr.colspan]="6">
              <div class="p-4">
                <div class="flex flex-col space-y-2">
                  <div class="flex flex-row space-x-4 w-full text-wrap" *ngIf="product?.comments">
                    <span class="font-bold mb-1 text-left mr-4 w-60">Comments</span>
                    <span class="text-overflow text-left">{{ product?.comments | uppercase }}</span>
                  </div>
                </div>
              </div>
            </td>
          </tr>
        </ng-template>
        <ng-template pTemplate="footer">
          <tr>
            <td [attr.colspan]="8" class="p-text-right">
              <span class="ml-6">({{ totalProducts }}) Total Components</span>
            </td>
          </tr>
        </ng-template>
      </p-table>
    </div>
  </fuse-card>
</div>

</ng-template>
